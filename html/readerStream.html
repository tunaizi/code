<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadableStream</title>
</head>

<body>
  <h1>ReadableStream to test</h1>
  <button onclick="main()">start</button>
</body>
<script>
  var main = null
  window.onload = function () {
    const protoTypeof = (tag) => Object.prototype.toString.call(tag).slice(8, -1).toLocaleLowerCase()
    const isSet = (tag) => protoTypeof(tag) == 'set'
    const isReadablestream = (tag) => protoTypeof(tag) == 'readablestream'
    const isBool = (tag) => protoTypeof(tag) == 'boolean'
    const isMap = (tag) => protoTypeof(tag) == 'map'
    const isFun = (tag) => protoTypeof(tag) == 'function'
    const isObj = (tag) => protoTypeof(tag) == 'object'
    const isDate = (tag) => protoTypeof(tag) == 'date'
    const isNum = (tag) => protoTypeof(tag) == 'number'
    const isStr = (tag) => protoTypeof(tag) == 'string'
    const isSymbol = (tag) => protoTypeof(tag) == 'symbol'
    const isArr = (tag) => protoTypeof(tag) == 'array'
    const isDef = (tag) => !['undefined', 'null'].includes(protoTypeof(tag))
    /** 
    * @desc typeof utlis
    **/

    function ArrayBufferToBase64(buffer) {
      //第一步，将ArrayBuffer转为二进制字符串
      var binary = '';
      var bytes = new Uint8Array(buffer);
      for (var len = bytes.byteLength, i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      //将二进制字符串转为base64字符串
      return window.btoa(binary);
    }
    const downloadLink = function (blob, fname = null) {
      // console.log(blob.type);
      const filename = fname || 'abc.js'
      const objectUrl = URL.createObjectURL(blob)
      const a = document.createElement("a")
      document.body.appendChild(a)
      a.style = "display: none"
      a.href = objectUrl
      a.download = filename
      a.click()
      window.URL.revokeObjectURL(objectUrl)
    }
    const fetchReadStram = async function (res) {
      const { body } = res
      console.log(isReadablestream(body));
      /* 
      if (isReadablestream(body)) {
        const reader = body.getReader();
        const stream = await new ReadableStream({
          start(controller) {
            function push() {
              reader.read().then(({ done, value }) => {
                if (done) { return controller.close() }
                controller.enqueue(value);
                push();
              });
            }
            push();
          }
        });
      }
      return new Response(stream, { headers: { 'Content-Type': 'text/html' } }).text()
      */
      return res.blob()
    }

    function ajax({ data = null, async = true, url = null, type = 'GET', responseType, useOverrideMimeType = '' }) {
      const restype = ["arraybuffer", "blob", "document", "json", "text"].includes(responseType) ? responseType : ''
      function formsParams(data) {
        const arr = []
        for (let index in data) {
          arr.push(data[index])
        }
        return arr.join('&')
      }
      return new Promise((res, rej) => {
        try {
          const xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP")
          useOverrideMimeType && xhr.overrideMimeType(useOverrideMimeType);
          xhr.responseType = restype;
          if (type === 'GET') {
            const getUrl = data ? url + "?" + formsParams(data) : url
            xhr.open(type, getUrl, async)
            xhr.send()
          } else if (type === 'POST') {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.open(type, url, async)
            xhr.send(data)
          }
          xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status >= 200 && xhr.status < 300) {
              res(xhr.response);
            }
          }
        } catch (err) {
          rej(err)
        }
      })
    }
    main = function () {

      function utf8ToBase64(str) {
        return window.btoa(encodeURI(str))
      }
      function base64ToUtf8(str) {
        return decodeURI(window.atob(str))
      }

      // const url = 'http:127.0.0.1:3000/A87Pro11.exe'
      const url = 'https://cdn.bootcdn.net/ajax/libs/vue/2.6.1/vue.min.js'
      // fetch(url).then(fetchReadStram).then((e) => downloadLink(e, 'mock.json'))
      // ajax({ type: 'GET', url, async: true }).then((e) => {
      // const base64 = ArrayBufferToBase64(e)
      // console.log(base64);
      // const blob = new Blob([base64], { type: 'application/octet-stream' })
      // downloadLink(e, 'adsa.js')
      // console.log(e);
      // })


      let encodedData = utf8ToBase64("Fs十点四出手大方的士大夫十分 士大夫是❤☺(●ˇ∀ˇ●)(　o=^•ェ•)o　┏━┓(❤´艸｀❤)₰"); // 编码
      let decodedData = base64ToUtf8(encodedData);    // 解码
      console.log(encodedData, decodedData);
    }
  }
</script>


</html>